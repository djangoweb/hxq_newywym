{template 'header'}
<style type='text/css'>
body{background: #f0f0f0}
.top{width:100%;position: relative;font-size: 0}
#topthumbs{display: block;}
.detail{margin:0px ;background: #fff;padding:10px 0px; }
.detail_logo{text-align:center;position: absolute;left: 5px;bottom:0px;width: 50px;height: 50px;}
.detail_logo img{ border: 2px solid #fff;width: 100%;height: 100% }
.detail_name{height: 35px;line-height:35px;font-size: 1.8rem;color: #7a7a7a}
.detail_name_{height: 35px;line-height:35px;font-size: 1.8rem;font-weight: bolder;}
.detail_type{width:33%;float: left;height: 50px; line-height:50px;text-align: center;color: #7a7a7a;font-size: 1.4rem}
.detail_hour{width:33%;float: left;height: 50px;text-align: center;line-height:50px;color: #7a7a7a;font-size: 1.4rem}
.detail_row{margin:10px 0px;padding:0 13px; background: #fff;font-size: 1.4rem}
.detail_row:first-child{margin-top: 0px;}
.detail_row:last-child{margin-bottom: 0px;}
.detail-local{}
.coupon{margin:10px 0px 10px 0px; padding: 1px 0px; background: #fff}
.coupon_header{height: 30px;line-height:30px;margin:10px 13px;font-size: 1.4rem;text-align: center}
.product_list{margin:auto 13px;padding: 1px 0px;background: #fff}
.coupon_list{margin:auto 13px;padding: 1px 0px;}
.coupon_row{margin:10px auto;}
.biz{position: relative;}
.biz:before{position: absolute;height: 70%;top:15%;left:0px;width: 1px;background:rgba(255,255,255,0.4);content:"";}
.detail-location{float:left;width: 20px;height: 30px;line-height: 30px;}
.detail-address{margin:0 25px 0 25px;height: 30px;line-height: 30px;font-size: 1.4rem;display: block;color:#000;}
.detail-phone{float:right;width: 20px;height: 30px;line-height: 30px;}
.detail_thumbs{text-align:center;position: absolute;right:10px;bottom:5px;width: 40px;height: 40px;border-radius: 50%;background: rgba(0,0,0,0.6)}
.detail_thumbs_title{font-size: 12px;color: #cccccc;line-height: 20px;}
.product{position:relative;margin-top: 10px;margin-bottom: : 10px;float:left;width:30%;display: block;}
.product:nth-child(3n+2){margin-left: 5%}
.product:nth-child(3n+3){margin-left: 5%}
.product-thumb{width:100%;font-size: 0}
.product-title{text-align: left;font-size: 1.4rem;color:#000;white-space:normal;word-wrap:break-word;padding: 0 4px;line-height:18px;margin-top:5px; }
.gradbox{ margin:10px 1px 10px 1px; padding: 0px;}
.gradbox>.grad{display: block;width: 33.33%;list-style: none;float: left; text-align: center;box-sizing: border-box; text-align: center; padding:0px;background: #fff;position: relative;height: 68px;line-height:28px;}
.gradbox>.grad:nth-child(2n+0):before{position: absolute;height: 60%;top:20%;left:0px;width: 1px;background:rgba(200,200,200,0.8);content:"";}
.gradbox>.grad:nth-child(3n+0):before{position: absolute;height: 60%;top:20%;left:0px;width: 1px;background:rgba(200,200,200,0.8);content:"";}
.gradbox>.grad .smsym{font-size: 1rem;color: red;vertical-align: baseline;}
.newcoupon{margin: 10px auto}
</style>
<div class="top"><a href="javascript:;" id="topthumbs"><img src="{$_W[attachurl]}{$biz['thumb']}" width="100%" height="150"></a><div class="detail_logo"><img src="{$_W[attachurl]}{$biz['logo']}" width="50" height="50"></div>{if $biz['totalthumbs']>0}<div class="detail_thumbs"><i class="icon-photo icon-photo-mg"></i><div class="detail_thumbs_title">{$biz['totalthumbs']}张</div></div>{/if}</div>
<div class="detail">
  <div class="detail_row detail_name"><span class="detail_name_">{$biz['name']}</span> {$_M['indstc'][$biz['indstp']][$biz['indstc']]} {$biz['biz_hours']}</div>
  <div class="detail_row"><div class="detail-location"><i class="icon-location icon-lc-mg"></i></div><div class="detail-phone"><a href="tel:{$biz['phone']}" class="icon-phone icon-phone-mg"></a></div><a class="detail-address" href="javascript:;">{$biz['address']}</a>
</div>
</div>
<ul class=gradbox>
<li class="grad"><a href="{php echo $this->createmobileurl('index',array('cateid'=>$cate['id']))}" class="grad-a"><i class="icon-activity"></i><div>扫码活动</div></a></li>
<li class="grad"><a href="{php echo $this->createmobileurl('awardedrcd',array('cateid'=>$cate['id'],'type'=>'coupon'))}" class="grad-a"><i class="icon-quan"></i><div>优惠/兑换券<span class="smsym">({$totfancp}张)</span></div></a></li>
<li class="grad"><a href="{php echo $this->createmobileurl('awardedrcd',array('cateid'=>$cate['id'],'type'=>'1'))}" class="grad-a"><i class="icon-redpack "></i><div>已领红包<span class="smsym">({$totfanrp}元)</span></div></a></li>
<div class="clearfix"></div>
</ul>
{if $coupons}
<div class="coupon">
<div class="coupon_header"><span class="icon_quan">券</span> 优惠券</div>
<div class="coupon_list">
{loop $coupons $item}
<div class="newcoupon newcoupon{$item['style']}">
  <div class="newcoupon-row1">
    <div class="newcoupon-row1-l"><div class="newcoupon-row1-1-1">{$item['value']}</div><div class="newcoupon-row1-1-2">{$_M['coupontypes'][$item['type']]}</div></div><div class="newcoupon-row1-r">{if !$item['grant']}<a class="newcoupon-row1-r-btn" href="javascript:;"  data-id="{$item['id']}">领取</a><div class="newcoupon-row1-r-desc"></div>{else}{if $item['grant']['veriftime']}<a class="newcoupon-row1-r-btndisable" href="javascript:;"  data-id="{$item['id']}">已使用</a>{else}<a class="newcoupon-row1-r-btn newcoupon-row1-r-btn_"  href="{php echo $this->createmobileurl('coupon',array('op'=>'displayverif','id'=>$item['grant']['id'],'cateid'=>$cate['id']))}"  data-id="{$item['id']}">使用</a><div class="newcoupon-row1-r-desc">已领取</div>{/if}{/if}</div>
    <div class="newcoupon-row1-c"><div class="newcoupon-row1-c-1">{$item['name']}</div><div class="newcoupon-row1-c-2">有效期{php echo date('Y-m-d',$item['starttime'])}至{php echo date('Y-m-d',$item['endtime'])}</div></div></div>
    <div class="newcoupon-row2">
    <div class="newcoupon-row2-l"><img src="{MODULE_URL}images/cl_{$item['style']}.png?{TIMESTAMP}" width="100%"></div><div class="newcoupon-row2-r"><img src="{MODULE_URL}images/cr_{$item['style']}.png?{TIMESTAMP}" width="100%"></div>
    <div class="newcoupon-row2-c"><div class="newcoupon-row2-c-1"></div><div class="newcoupon-row2-c-2"></div></div></div>
  <div class="newcoupon-row3">{$item['requirement']}</div>
</div>
{/loop}
</div>
</div>
{/if}
{if $products}
<div class="coupon">
<div class="coupon_header"><span class="icon_jian">荐</span> 特别推荐</div>
<div class="product_list">
{loop $products $item}
<a class="product" href="{php echo $this->createmobileurl('product',array('id'=>$item['id']))}">
<div class="product-thumb"><img src="{$_W['attachurl']}{$item['thumb']}" width="100%" onload="this.height=this.width"/></div>
<div class="product-title">{$item['name']}</div>
</a>
{/loop}
<div class="clearfix"></div>
</div>
</div>
{/if}
<script type="text/javascript">
  biz={php echo json_encode($biz)};
  require(['jquery','main','weixin'],function($,main,wx){ 
    $('.newcoupon-row1-r-btn').on('click',function(){
      if ($(this).hasClass('newcoupon-row1-r-btn_')){
        return;
      }
            self=this
             $.post("{php echo $this->createmobileurl('coupon',array('op'=>'get','cateid'=>$cate['id']))}",{id:$(this).data('id')},function(data){
                if (data.errno==0){
                  $('#timeoutlayer').showlayer('领取成功','',3,true,'middle','')
                  $(self).html('使用').attr('href','{php echo $this->createmobileurl('coupon',array('op'=>'displayverif','cateid'=>$cate['id']))}&id='+data.id).addClass('newcoupon-row1-r-btn_').off();
                  $(self).next().html('已领取')
                }else{
                  $('#timeoutlayer').showlayer(data.message,'',3,false,'middle','','')
                }
             },'JSON')
    })

    $('#topthumbs').on('click',function(){
              if (jsonlength(biz.thumbs)>0){
                $(biz.thumbs).each(function(index,val){
                  biz.thumbs[index]=window.sysinfo.attachurl+val
                })
              wx.previewImage({
current: biz.thumbs[0], // 当前显示图片的http链接
urls: biz.thumbs // 需要预览的图片http链接列表
});    }
    })
    /*if (biz.lng&&biz.lat){
          $.get('{if $_W['ishttps']}https{else}http{/if}://apis.map.qq.com/ws/coord/v1/translate',{'locations':biz.lng+','+biz.lat,'type':3,'key':'YJGBZ-4FZRQ-MSB55-GLXAU-USHPJ-MIFXX','output':'json'},function(data){
            biz.lat=data.locations.lat;
            biz.lng=data.locations.lng
          })
        }*/
    $('.detail-address').on('click',function(){
      if (biz.lng&&biz.lat){
          wx.openLocation({
            latitude: parseFloat(biz.lat), // 纬度，浮点数，范围为90 ~ -90
            longitude: parseFloat(biz.lng), // 经度，浮点数，范围为180 ~ -180。
            name: biz.name, // 位置名
            address: biz.address, // 地址详情说明
            scale: 16, // 地图缩放级别,整形值,范围从1~28。默认为最大
            infoUrl: window.sysinfo.siteroot+'{php echo $this->createmobileurl('biz',array('cateid'=>$cate['id']))}', // 在查看位置界面底部显示的超链接,可点击跳转
            error:function(res){
              alert(JSON.stringify(res))
            },
            fail:function(res){
              alert(JSON.stringify(res))
            }
            });
        }
      })
  })
</script>
<div id="couponlayer" class="layercontent">
<span class="close_ close submit" data-target=''>×</span>
<div class="header">领取成功</div>
<div class="body">
<div class="message"></div>
<div class="description"></div>
</div>
<div class="footer"><a class="button" href="{php echo $this->createmobileurl('coupon',array('cateid'=>$cate['id']))}">查看优惠券详情</a></div>
</div>
<div id="timeoutlayer" class="layercontent"><div class="message"></div></div>
{template 'footer'}